<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Children's Story Generator</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Comic+Neue:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Comic Neue', cursive;
            background-color: #f7fee7;
        }
        .loading {
            display: none;
        }
        .loading.active {
            display: block;
        }
        .progress-step {
            position: relative;
            flex: 1;
            text-align: center;
            padding: 1rem;
        }
        .progress-step:not(:last-child)::after {
            content: '';
            position: absolute;
            top: 50%;
            right: 0;
            width: 100%;
            height: 4px;
            background-color: #e5e7eb;
            transform: translateY(-50%);
            z-index: 1;
        }
        .progress-step.active {
            color: #84cc16;
        }
        .progress-step.active::after {
            background-color: #84cc16;
        }
        .progress-step.completed {
            color: #84cc16;
        }
        .progress-step.completed::after {
            background-color: #84cc16;
        }
        .progress-step .step-number {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 2.5rem;
            height: 2.5rem;
            border-radius: 50%;
            background-color: #e5e7eb;
            color: #6b7280;
            margin-bottom: 0.75rem;
            position: relative;
            z-index: 2;
            font-weight: bold;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .progress-step.active .step-number {
            background-color: #84cc16;
            color: white;
            box-shadow: 0 4px 6px rgba(132,204,22,0.3);
        }
        .progress-step.completed .step-number {
            background-color: #84cc16;
            color: white;
            box-shadow: 0 4px 6px rgba(132,204,22,0.3);
        }
        .card {
            background-color: white;
            border-radius: 1rem;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            transition: transform 0.2s;
        }
        .card:hover {
            transform: translateY(-2px);
        }
        .btn-primary {
            background-color: #84cc16;
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 0.75rem;
            font-weight: bold;
            transition: all 0.2s;
        }
        .btn-primary:hover {
            background-color: #65a30d;
            transform: translateY(-1px);
        }
        .loading-spinner {
            border: 4px solid #84cc16;
            border-top: 4px solid transparent;
            border-radius: 50%;
            width: 2.5rem;
            height: 2.5rem;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="min-h-screen">
    <div class="container mx-auto px-4 py-8">
        <header class="text-center mb-8">
            <h1 class="text-5xl font-bold text-lime-600 mb-4 transform hover:scale-105 transition-transform duration-300">
                Children's Story Generator
            </h1>
            <p class="text-xl text-gray-600">Create magical stories with AI!</p>
        </header>

        <div class="max-w-2xl mx-auto card p-8">
            <form id="storyForm" class="space-y-6">
                <div>
                    <label for="description" class="block text-lg font-medium text-gray-700 mb-2">Character Description</label>
                    <textarea id="description" name="description" rows="4" 
                        class="w-full rounded-xl border-2 border-gray-200 p-4 focus:border-lime-500 focus:ring-2 focus:ring-lime-200"
                        placeholder="For example: I want to create a little cat who loves adventures, with blue fur and big eyes, cheerful and helpful personality."></textarea>
                </div>
                <button type="submit" class="btn-primary w-full">
                    Generate Story
                </button>
            </form>
        </div>

        <div id="loading" class="loading text-center mt-12">
            <div class="flex justify-between items-center mb-12">
                <div class="progress-step" id="step1">
                    <div class="step-number">1</div>
                    <div class="text-lg font-medium">Create Character</div>
                </div>
                <div class="progress-step" id="step2">
                    <div class="step-number">2</div>
                    <div class="text-lg font-medium">Generate Story</div>
                </div>
                <div class="progress-step" id="step3">
                    <div class="step-number">3</div>
                    <div class="text-lg font-medium">Create Images</div>
                </div>
                <div class="progress-step" id="step4">
                    <div class="step-number">4</div>
                    <div class="text-lg font-medium">Make Book</div>
                </div>
            </div>
            <div class="loading-spinner mx-auto"></div>
            <p id="loadingText" class="mt-4 text-xl text-gray-600">Generating your story...</p>
        </div>

        <div id="result" class="mt-12 hidden">
            <div class="card p-8">
                <h2 id="storyTitle" class="text-3xl font-bold text-lime-600 mb-6"></h2>
                
                <div id="characterInfo" class="mb-8 p-6 bg-lime-50 rounded-xl shadow-sm">
                    <h3 class="text-xl font-semibold text-lime-800 mb-4">Character Information</h3>
                    <div class="grid grid-cols-2 gap-6">
                        <div>
                            <p class="text-sm text-gray-600">Name</p>
                            <p id="characterName" class="text-lg font-medium"></p>
                        </div>
                        <div>
                            <p class="text-sm text-gray-600">Age</p>
                            <p id="characterAge" class="text-lg font-medium"></p>
                        </div>
                        <div>
                            <p class="text-sm text-gray-600">Appearance</p>
                            <div id="characterAppearance" class="font-medium">
                                <p class="text-sm">Physical Traits: <span id="physicalTraits"></span></p>
                                <p class="text-sm">Clothing: <span id="clothing"></span></p>
                                <p class="text-sm">Distinctive Features: <span id="distinctiveFeatures"></span></p>
                            </div>
                        </div>
                        <div>
                            <p class="text-sm text-gray-600">Personality</p>
                            <div id="characterPersonality" class="font-medium">
                                <p class="text-sm">Traits: <span id="personalityTraits"></span></p>
                                <p class="text-sm">Strengths: <span id="strengths"></span></p>
                                <p class="text-sm">Weaknesses: <span id="weaknesses"></span></p>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="scenes" class="space-y-8">
                    <!-- Scenes will be added dynamically -->
                </div>

                <div id="moral" class="mt-8 p-6 bg-lime-50 rounded-xl shadow-sm">
                    <h3 class="text-xl font-semibold text-lime-800 mb-4">The Moral of the Story:</h3>
                    <p id="moralText" class="text-lg text-lime-700"></p>
                </div>
            </div>
        </div>
    </div>

    <script>
        document.getElementById('storyForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const description = document.getElementById('description').value;
            const loading = document.getElementById('loading');
            const result = document.getElementById('result');
            const loadingText = document.getElementById('loadingText');
            
            // Reset progress steps
            document.querySelectorAll('.progress-step').forEach(step => {
                step.classList.remove('active', 'completed');
            });
            
            // Show loading state
            loading.classList.add('active');
            result.classList.add('hidden');
            
            try {
                const response = await fetch('/generate', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ description }),
                });
                
                if (!response.ok) {
                    throw new Error('Server response error');
                }
                
                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                let buffer = '';
                
                while (true) {
                    const { value, done } = await reader.read();
                    if (done) break;
                    
                    buffer += decoder.decode(value, { stream: true });
                    const lines = buffer.split('\n');
                    buffer = lines.pop() || '';
                    
                    for (const line of lines) {
                        if (!line.trim()) continue;
                        
                        const data = JSON.parse(line);
                        
                        if (data.error) {
                            throw new Error(data.error);
                        }
                        
                        switch (data.status) {
                            case 'generating_character':
                                document.getElementById('step1').classList.add('active');
                                loadingText.textContent = 'Creating your character...';
                                break;
                            case 'character_completed':
                                document.getElementById('step1').classList.remove('active');
                                document.getElementById('step1').classList.add('completed');
                                document.getElementById('step2').classList.add('active');
                                loadingText.textContent = 'Generating your story...';
                                break;
                            case 'generating_story':
                                loadingText.textContent = 'Generating your story...';
                                break;
                            case 'story_completed':
                                document.getElementById('step2').classList.remove('active');
                                document.getElementById('step2').classList.add('completed');
                                document.getElementById('step3').classList.add('active');
                                loadingText.textContent = 'Creating story images...';
                                break;
                            case 'generating_image':
                                loadingText.textContent = `Creating images (${data.scene}/${data.total})...`;
                                break;
                            case 'images_completed':
                                document.getElementById('step3').classList.remove('active');
                                document.getElementById('step3').classList.add('completed');
                                document.getElementById('step4').classList.add('active');
                                loadingText.textContent = 'Making your storybook...';
                                break;
                            case 'completed':
                                document.getElementById('step4').classList.remove('active');
                                document.getElementById('step4').classList.add('completed');
                                // Update character information
                                document.getElementById('characterName').textContent = data.character.name;
                                document.getElementById('characterAge').textContent = data.character.age;
                                
                                // Update appearance information
                                document.getElementById('physicalTraits').textContent = data.character.appearance.physical_traits.join(', ');
                                document.getElementById('clothing').textContent = data.character.appearance.clothing.join(', ');
                                document.getElementById('distinctiveFeatures').textContent = data.character.appearance.distinctive_features.join(', ');
                                
                                // Update personality information
                                document.getElementById('personalityTraits').textContent = data.character.personality.traits.join(', ');
                                document.getElementById('strengths').textContent = data.character.personality.strengths.join(', ');
                                document.getElementById('weaknesses').textContent = data.character.personality.weaknesses.join(', ');
                                
                                // Update story title
                                document.getElementById('storyTitle').textContent = data.story.title;
                                
                                // Update scenes
                                const scenesContainer = document.getElementById('scenes');
                                scenesContainer.innerHTML = '';
                                data.story.scenes.forEach((scene, index) => {
                                    const sceneElement = document.createElement('div');
                                    sceneElement.className = 'scene bg-lime-50 p-6 rounded-xl shadow-sm';
                                    sceneElement.innerHTML = `
                                        <h3 class="text-xl font-semibold text-lime-800 mb-4">Scene ${index + 1}</h3>
                                        <img src="${scene.image_path}" alt="Scene ${index + 1}" class="w-full rounded-lg mb-4">
                                        <p class="text-gray-700">${scene.description}</p>
                                    `;
                                    scenesContainer.appendChild(sceneElement);
                                });
                                
                                // Update moral
                                document.getElementById('moralText').textContent = data.story.moral;
                                
                                // Show result
                                result.classList.remove('hidden');
                                loading.classList.remove('active');
                                break;
                        }
                    }
                }
            } catch (error) {
                alert('Error: ' + error.message);
                loading.classList.remove('active');
            }
        });
    </script>
</body>
</html> 